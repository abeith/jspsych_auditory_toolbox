<!DOCTYPE html>
<html>
  <head>
      <script src="https://unpkg.com/jspsych@7.3.1"></script>
      <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
      <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
      <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />
      <script src="../packages/plugin-audio-audio-response/dist/index.browser.js"></script>
      <script src="../packages/plugin-latency-test/dist/index.browser.js"></script>
  </head>
  <body></body>
  <script>

   var jsPsych = initJsPsych({
       on_finish: function() {
           jsPsych.data.displayData();
       }
   });

   var timeline = [];

   var preload = {
       type: jsPsychPreload,
       auto_preload: true,
       audio: ['sound/speech_green.mp3', 'sound/chirp4.wav', 'sound/chirp16.wav']
   };

   timeline.push(preload);

   timeline.push({
       type: jsPsychHtmlButtonResponse,
       stimulus: '<div style="max-width:600px;"><p>Some browsers now require the user to interact with a page before it can play audio. '+
                 'Clicking the button below counts as an interaction.</p><p>Be aware of this when planning audio experiments if '+
                 'you want the first trial to include audio.</p></div>',
       choices: ['Continue']
   });

   // plugin-initialize-microphone doesn't work: Because it creates an
   // instance of MediaRecorder in addition to my microphone stream?
   timeline.push({
       type: jsPsychAudioAudioResponse,
       stimulus: 'sound/speech_green.mp3',
       prompt: "<p>dummy trial</p>",
       trial_duration: 2000
   });

   timeline.push({
       type: jsPsychHtmlButtonResponse,
       stimulus: '<div style="max-width:600px;"><p>WARNING!</p>'+
                 '<p>take headphones off and turn volume down volume!</p>',
       choices: ['Continue']
   });

   // audio context seems to require another click in Safari but not in Chrome of Firefox
   let next_trial = {
       type: jsPsychHtmlButtonResponse,
       stimulus: '<div style="max-width:600px;"><p>...</p>',
       choices: ['Continue']
   };

   let offline_latency_test = {
       type: jsPsychAudioAudioResponse,
       stimulus: 'sound/chirp4.wav',
       prompt: "<p>running latency test for offline analysis</p>",
       trial_duration: 2000,
       on_start: () => console.log('started'),
       on_load: () => console.log('loaded'),
       on_finish: () => console.log('finished')
   };

   let latency_trial = {
       type: jsPsychLatencyTest,
       stimulus: 'sound/chirp4.wav',
       trial_duration: 2000,
       dummy: false,
       f_max: 16000,
       fft_size: 2048,
       randomDelay: true,
       vol: 1
   };

   let rep_node = {
       timeline: [next_trial, offline_latency_test, latency_trial],
       repetitions: 2
   };

   timeline.push(rep_node);


   jsPsych.run(timeline);

  </script>
</html>
